# DiagrammeR_graphviz and memaid


```{r}
library(DiagrammeR)
library(DT)
```
## Keywords: 

- `create_graph()`: create a graph object, 
- `add_node`: add some nodes 
- `add_edge`: add edges to a graph.
- `delete_edge`:
- `node_aes`, `edge_aes`: contain arguments for each of the accepted node/edge aesthetic attributes (e.g., shape, style, color, fillcolor)/ (e.g., shape, style, penwidth, color). 
- `node_data`, and `edge_data`: help bind data specifically to the created nodes/edges.

## Graph Basics

Each node gets a new integer ID upon creation. Each edge also gets an ID starting from 1.
Viewing the graph object in the console will provide some basic information about the graph and some pointers on where to get additional information.

```{r, warning=FALSE}
a_graph <-
  create_graph() %>%
  add_node() %>%
  add_node() %>%
  add_edge( from = 1, to = 2) %>% 
  add_edge(from = 1, to=1)
render_graph(a_graph, title = "A simple graph", layout = "nicely")
```
```{r}
a_graph
```

- `delete_edge()`: deletes away an edge.

```{r}
b_graph <- a_graph %>% delete_edge(from = 1, to = 2)
render_graph(b_graph)
```

- `add_node(from = , to= )`: We can add a node to the graph while, at the same time, defining edges to or from existing nodes in the graph.

```{r}
c_graph <- b_graph %>% add_node(from = 1, to = 2)
render_graph(c_graph)
```
When there already an edge between two nodes ((1) and (3), for example). The `add_node()` will create two (other) edges that connect (1) to (4), and (4) to (3).
```{r}
c1_graph <- c_graph %>% add_node(from = 1, to = 3)
render_graph(c1_graph)
```
## Graphs with with styling properties (e.g., color, shape, ...), grouping labels (e.g., type and rel)

Any time we add a node or edge to the graph, we can add node or edge aesthetic or data attributes. These can be styling properties (e.g., color, shape), grouping labels (e.g., type and rel), or data values that are useful for calculations and for display purposes. Most node or edge creation functions (depending on whether they create either edges, nodes, or both) have the arguments `node_aes`, `edge_aes`, `node_data`, and `edge_data`. Using these, we can call the namesake helper functions (node_aes(), edge_aes(), node_data(), and edge_data()) to specifically target the created nodes or edges and bind attribute data. An additional benefit in using the helper functions (for the node/edge aesthetic attributes especially) is that RStudio can provide inline help on attribute names and definitions when typing node_aes( or edge_aes( and pressing the TAB key.


```{r}
d_graph <-
  c_graph %>%
  add_node(
    type = "type_a",
    node_aes = node_aes(
      color = "steelblue",
      fillcolor = "lightblue",
      fontcolor = "gray35"),
    node_data = node_data(
      value = 2.5)) %>%
  add_edge(
    from = 1, to = 3,
    rel = "interacted_with",
    edge_aes = edge_aes(
      color = "red",
      arrowhead = "vee",
      tooltip = "Red Arrow"),
    edge_data = edge_data(
      value = 5.2))
render_graph(d_graph, layout = "nicely")
```

- **select node/edge** ==> **set/mutate the nodes/edges** ==> **close the mutation**  

  - select nodes: `select_nodes`, `select_nodes_by_id()`, `select_last_nodes_created` \
  - select edge: `select_edges()`, `select_edges_by_edge_id()`, `select_last_edges_created()` \
  - muttate nodes/edges: `set_node_attrs_ws()`, `mutate_node_attrs_ws()`, `delete_nodes_ws()`, `create_subgraph_ws()`. \
  - close the mutation: `invert_selection`, `deselect_nodes()`/`deselect_edges()`, `clear_selection`. 

Creating attributes and setting their values is often useful because we can further work with the attributes. Furthermore, we can create aesthetic properties based on numerical or categorical data. This is important for when you want to display your graph diagram using the render_graph() function.


```{r}
e_graph <-
  d_graph %>%
  select_nodes(conditions = value == 2.5) %>%
  set_node_attrs_ws(node_attr = fillcolor, value = "orange") %>%
  clear_selection()
render_graph(e_graph)
```
```{r}
f_graph <-
  create_graph() %>%
  add_path(n = 3) %>% # add a path that connect 1, 2, 3
  add_cycle(n = 4) %>%  # add cycle that connect 4->5->6->7->4
  add_balanced_tree(k = 2, h = 2)
render_graph(f_graph)
```

## Using Data from Tables to Generate a Graph

The DiagrammeR package contains a few simple datasets that help illustrate how to create a graph with table data. The `node_list_1` and `edge_list_1` datasets are super simple node and edge data frames that can be assembled into a graph. Let’s print them side by side to see what we’re working with.
```{r}
datatable(node_list_1)     
datatable(edge_list_1)
```
To fashion this into a graph, we need to ensure that both the nodes and their attributes (in this case, just a label) are added, and, that the edges are added. Furthermore, we must map the from and the to definitions to the node id (in other cases, we may need to map relationships between text labels to the same text attribute stored in the node data frame). We can use three functions to generate a graph containing this data:

`create_graph()` \
`add_nodes_from_table()` \
`add_edges_from_table()` \

```{r}
# Create the graph object
i_graph_1 <- create_graph() %>%
  add_nodes_from_table(
    table = node_list_1,
    label_col = label) %>% 
 add_edges_from_table(
    table = edge_list_1,
    from_col = from,
    to_col = to,
    from_to_map = id_external)
render_graph(i_graph_1)
```

## grViz - Keyword - Key structure 

```{r eval=FALSE, echo=TRUE}
DiagrammeR::grViz("(digraph|graph) graph_name{
graph[...graph_stmt...]
#
node[...node_stmt...]
a[...]
b[...]
# /*Comment: here are for */
a -> b # must use -> for direct graph digraph
a -- b # must use -- for undirected graph
}")
```

### A minimal grViz plot

```{r}
DiagrammeR::grViz("digraph {
graph[layout = dot, rankdir = LR]
a; b; c
a -> b -> c c->b
}")
```

### DiagrammeR Implementation

For Graphviz graphs, DiagrammeR uses the processing function called grViz(). What you pass into grViz() is a valid graph specification in the DOT language. The DOT graph description can either be delivered to grViz() in the form of a string, a reference .gv file or as a text connection.

The Graphviz graph specification must begin with a directive stating whether a directed graph (`digraph`) or an indirect graph (`graph`) is desired. Semantically, this indicates whether or not there is a natural direction from one of the edge's nodes to the other. An optional graph ID follows this and paired curly braces denotes the body of the statement list (stmt_list).

Optionally, a graph may also be described as strict. This forbids the creation of multi-edges (i.e., there can be at most one edge with a given tail node and head node in the directed case). For indirect graphs, there can be at most one edge connected to the same two nodes. Subsequent edge statements using the same two nodes will identify the edge with the previously defined one and apply any attributes given in the edge statement.

### Simple table {.tabset}

#### Horizontal flowchart

Adding `rankdir` = LR in the graph statement will give us a horizontal flowchart

```{r}
DiagrammeR::grViz("digraph {

graph [layout = dot, rankdir = LR]

# define the global styles of the nodes. We can override these in box if we wish
node [shape = rectangle, style = filled, fillcolor = Linen]

data1 [label = 'Dataset 1', shape = folder, fillcolor = Beige]
data2 [label = 'Dataset 2', shape = folder, fillcolor = Beige]
process [label =  'Process \n Data']
statistical [label = 'Statistical \n Analysis']
results [label= 'Results']

# edge definitions with the node IDs
{data1 data2}  -> process -> statistical -> results
}")
```

#### Vertical flowchart 
Not adding rankdir = LR in the graph statement will give us a vertical flowchart.  
```{r}
grViz("digraph {

graph [layout = dot]

# define the global styles of the nodes. We can override these in box if we wish
node [shape = rectangle, style = filled, fillcolor = Linen]

data1 [label = 'Dataset 1', shape = folder, fillcolor = Beige]
data2 [label = 'Dataset 2', shape = folder, fillcolor = Beige]
process [label =  'Process \n Data']
statistical [label = 'Statistical \n Analysis']
results [label= 'Results']

# edge definitions with the node IDs
{data1 data2}  -> process -> statistical -> results
}")
```

### Parameterized figures - Graphviz Substitution

A great benefit of designing figures within R is that we are able to connect the figures directly with our analysis by reading R values directly into our flowcharts.

To do this we, you can use the @@X symbol directly within the figure, then refer to this in the footer of the plot using [X]:, where X is the a unique **numeric** index.

```{r}
# Define some sample data contains your R values
data <- list(a=1000, b=800, c=600, d=400)
# Create the graph using values gotten from the data
grViz("
digraph graph2 {
  graph [layout = dot]
  # node definitions with substituted label text
  node [shape = rectangle, width = 4, fillcolor = Biege]
  o [label = '@@1']
  a [label = '@@2']
  b [label = '@@3']
  c [label = '@@4']
  d [label = '@@5']
  
  o ->a -> b -> c -> d
  }
  
  [1]: 'start your diagram'
  [2]: paste0('Raw Data (n = ', data$a, ')')
  [3]: paste0('Remove Errors (n = ', data$b, ')')
  [4]: paste0('Identify Potential Customers (n = ', data$c, ')')
  [5]: paste0('Select Top Priorities (n = ', data$d, ')')
")
```

### Subgraphs and clusters {.tabset}

#### Using label
```{r}
grViz("
digraph a_nice_graph {

  # node definitions with substituted label text
  node [fontname = Helvetica]
  a [label = '@@1']
  b [label = '@@2-1']
  c [label = '@@2-2']
  d [label = '@@2-3']
  e [label = '@@2-4']
  f [label = '@@2-5']
  g [label = '@@2-6']
  h [label = '@@2-7']
  i [label = '@@2-8']
  j [label = '@@2-9']
  
  # edge definitions with the node IDs
  a -> {b c d e f g h i j}
  }
  
  [1]: 'top'
  [2]: 10:20
")
```

#### Not using label

```{r}
grViz("
digraph a_nice_graph {

  # node definitions with substituted label text
  node [fontname = Helvetica]
  
  # edge definitions with the node IDs
  '@@1' -> {'@@2-1' '@@2-2' '@@2-3' '@@2-4' '@@2-5' '@@2-6' '@@2-7''@@2-8''@@2-9'}
  }
  
  [1]: 'top'
  [2]: 10:20
")
```

### Node data frames (NDFs) and Edge data frames (EDFs)

- `create_nodes()` function creates NDF with nodes and their attributes, including:
  - 
single values are repeated for n number of nodes supplied
selective setting of attributes (e.g., giving attr values for 3 of 10 nodes, allowing non-set nodes to use defaults or globally set attr values)
supplying overlong vectors for attributes will result in trimming down to the number of nodes
setting `label = FALSE` will conveniently result in a non-labeled node
The function only has one argument that requires values to be supplied: the nodes argument. Just supplying a set of unique ID values for nodes will create an NDF with nodes that have no additional attributes.

```{r}
# Create a node data frame
nodes_1 <-
  create_node_df(
    n=4,
    nodes = c("a", "b", "c", "d"),
    label = FALSE,
    type = "lower",
    style = "filled",
    color = "aqua",
    shape = c("circle", "circle",
              "rectangle", "rectangle"),
    data = c(3.5, 2.6, 9.4, 2.7))

nodes_1
```
```{r}
# Create another node data frame
nodes_2 <-
  create_node_df(
    n=4,
    nodes = 1:4,
    label = TRUE,
    type = "upper",
    style = "filled",
    color = "red",
    shape = "triangle",
    data = c(0.5, 3.9, 3.7, 8.2))

# Inspect the `nodes_2` NDF
nodes_2
#>   nodes  type label  style color    shape data
#> 1     1 upper     1 filled   red triangle  0.5
#> 2     2 upper     2 filled   red triangle  3.9
#> 3     3 upper     3 filled   red triangle  3.7
#> 4     4 upper     4 filled   red triangle  8.1
```


```{r}
# Create a simple NDF
nodes <-
  create_node_df(
    n=4, 
    nodes = 1:4,
    shape = c("circle", "circle", "rectangle", "rectangle"),
    type = "number")

# Create a simple EDF
edges <-
  create_edge_df(
    n=4, 
    from = c(1, 1, 3, 1),
    to = c(2, 3, 4, 4),
    rel = "leading_to"
    )

g <- create_graph(nodes_df=nodes, 
                  edges_df=edges)

render_graph(g)
```


```{r, eval=FALSE, include=FALSE}
# Reference: http://rich-iannone.github.io/DiagrammeR/graphviz_and_mermaid.html
grViz("
digraph nicegraph {

  # graph, node, and edge definitions
  graph [compound = true, nodesep = .5, ranksep = .25,
         color = crimson]

  node [fontname = Helvetica, fontcolor = darkslategray,
        shape = rectangle, fixedsize = true, width = 1,
        color = darkslategray]

  edge [color = grey, arrowhead = none, arrowtail = none]

  # # subgraph for R information
  subgraph cluster0 {
    node [fixedsize = true, width = 3]
    '@@1-1' -> '@@1-2' -> '@@1-3' -> '@@1-4'
    '@@1-4' -> '@@1-5' -> '@@1-6' -> '@@1-7'
  }
  # 
  # # subgraph for RStudio information
  # subgraph cluster1 {
  #   node [fixedsize = true, width = 3]
  #   '@@2' -> '@@3'
  # }

  Information [width = 1.5]
  Information -> R
  Information -> RStudio
  # R -> '@@1-1' [lhead = cluster0]
  # RStudio -> '@@2' [lhead = cluster1]

}

[1]: paste0(names(R.Version())[1:7], ':\\n ', R.Version()[1:7])
# [2]: paste0('RStudio version:\\n ', rstudioapi::versionInfo()[[1]])
# [3]: paste0('Current program mode:\\n ', rstudioapi::versionInfo()[[2]])

")
```


```{r subgraphs, echo = FALSE, fig.cap="An example of subgraphs used to highlight grouping within a dataset", eval=FALSE}
DiagrammeR::grViz("planningGrouping.gv")
```





```{r}
grViz("
digraph boxes_and_circles {

  # a 'graph' statement
  graph [overlap = true, fontsize = 10]

  # several 'node' statements
  node [shape = box,
        fontname = Helvetica]
  A; B; C; D; E; F

  node [shape = circle,
        fixedsize = true,
        width = 0.9] // sets as circles
  1; 2; 3; 4; 5; 6; 7; 8

  # several 'edge' statements
  A->1 B->2 B->3 B->4 C->A
  1->D E->A 2->4 1->5 1->F
  E->6 4->6 5->7 6->7 3->8
}
")
```






```{r}
# Create a simple NDF
# nodes <-
#   create_nodes(
#     nodes = 1:4,
#     type = "number")
# 
# # Create a simple EDF
# edges <-
#   create_edges(
#     from = c(1, 1, 3, 1),
#     to = c(2, 3, 4, 4),
#     rel = "related")
# 
# # Create the graph object, incorporating the NDF and the EDF, and, 
# # providing some global attributes
# graph <-
#   create_graph(
#     nodes_df = nodes,
#     edges_df = edges,
#     graph_attrs = "layout = neato",
#     node_attrs = "fontname = Helvetica",
#     edge_attrs = "color = gray20")
# 
# # View the graph
# render_graph(graph)
```


## References

[DiagrammeR main page](http://visualizers.co/diagrammer/) \
[https://mikeyharper.uk/flowcharts-in-r-using-diagrammer/](https://mikeyharper.uk/flowcharts-in-r-using-diagrammer/) \
[http://rich-iannone.github.io/DiagrammeR/graph_creation.html](http://rich-iannone.github.io/DiagrammeR/graph_creation.html)